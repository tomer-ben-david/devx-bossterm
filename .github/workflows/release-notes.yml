name: Generate Release Notes

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to generate notes for (e.g., v1.0.45)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get release info
        id: release_info
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.release_tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

          PREV_TAG=$(git describe --tags --abbrev=0 "$TAG^" 2>/dev/null || echo "")
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

          RELEASE_DATE=$(git log -1 --format=%cs "$TAG" 2>/dev/null || date +%Y-%m-%d)
          echo "release_date=$RELEASE_DATE" >> $GITHUB_OUTPUT

          # Get commits
          if [[ -n "$PREV_TAG" ]]; then
            git log "$PREV_TAG..$TAG" --pretty=format:"- %s" --no-merges > commits.txt
          else
            git log "$TAG" --pretty=format:"- %s" --no-merges -20 > commits.txt
          fi

          echo "Tag: $TAG, Previous: $PREV_TAG, Date: $RELEASE_DATE"
          echo "Commits:"
          cat commits.txt

      - name: Create release notes directory
        run: mkdir -p docs/release-notes

      - name: Generate release notes with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--allowedTools 'Bash(git:*)' 'Bash(gh:*)' 'Read' 'Write' 'Edit' 'Glob'"
          prompt: |
            You need to generate release notes for BossTerm ${{ steps.release_info.outputs.tag }} and commit them.

            Info:
            - Tag: ${{ steps.release_info.outputs.tag }}
            - Previous: ${{ steps.release_info.outputs.prev_tag }}
            - Date: ${{ steps.release_info.outputs.release_date }}
            - Commits are in: commits.txt

            INSTRUCTIONS:
            1. Read commits.txt to see what changed
            2. Create docs/release-notes/${{ steps.release_info.outputs.tag }}.md with this format:

               # Release Notes - ${{ steps.release_info.outputs.tag }}

               **Release Date:** ${{ steps.release_info.outputs.release_date }}

               ## Highlights
               [Brief 1-2 sentence summary]

               ## New Features
               [List or omit if none]

               ## Bug Fixes
               [List or omit if none]

               ## Improvements
               [List or omit if none]

               ## Breaking Changes
               None

               ## Full Changelog
               https://github.com/kshivang/BossTerm/compare/${{ steps.release_info.outputs.prev_tag }}...${{ steps.release_info.outputs.tag }}

            3. Read docs/release-notes/README.md and add a link to this new release at the top of the releases list

            4. After creating the files, run these git commands:
               git add docs/release-notes/
               git commit -m "docs: Add release notes for ${{ steps.release_info.outputs.tag }}"
               git push

            5. Update the GitHub release with the same notes using:
               gh release edit ${{ steps.release_info.outputs.tag }} --notes-file docs/release-notes/${{ steps.release_info.outputs.tag }}.md

            Git and gh are already configured. Just run the commands.
