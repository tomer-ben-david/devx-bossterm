name: Generate Release Notes

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to generate notes for (e.g., v1.0.45)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get release info
        id: release_info
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.release_tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 "$TAG^" 2>/dev/null || echo "")
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

          # Get release date
          RELEASE_DATE=$(git log -1 --format=%cs "$TAG" 2>/dev/null || date +%Y-%m-%d)
          echo "release_date=$RELEASE_DATE" >> $GITHUB_OUTPUT

          echo "Current tag: $TAG"
          echo "Previous tag: $PREV_TAG"
          echo "Release date: $RELEASE_DATE"

      - name: Get commits since last release
        id: commits
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"
          PREV_TAG="${{ steps.release_info.outputs.prev_tag }}"

          if [[ -n "$PREV_TAG" ]]; then
            git log "$PREV_TAG..$TAG" --pretty=format:"- %s" --no-merges > /tmp/commits.txt
          else
            git log "$TAG" --pretty=format:"- %s" --no-merges -20 > /tmp/commits.txt
          fi

          # Escape for JSON
          COMMITS=$(cat /tmp/commits.txt | jq -Rs .)
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT

      - name: Generate release notes with Claude API
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"
          VERSION="${{ steps.release_info.outputs.version }}"
          PREV_TAG="${{ steps.release_info.outputs.prev_tag }}"
          RELEASE_DATE="${{ steps.release_info.outputs.release_date }}"
          COMMITS=$(cat /tmp/commits.txt)

          # Create prompt
          PROMPT="Generate concise release notes for BossTerm ${TAG}.

          Release date: ${RELEASE_DATE}
          Previous version: ${PREV_TAG}

          Commits:
          ${COMMITS}

          Output ONLY the markdown content (no code blocks), using this exact format:

          # Release Notes - ${TAG}

          **Release Date:** ${RELEASE_DATE}

          ## Highlights
          Brief 1-2 sentence summary of the most important changes.

          ## New Features
          - Feature: Description (only if there are new features, otherwise omit section)

          ## Bug Fixes
          - Fix: Description (only if there are bug fixes, otherwise omit section)

          ## Improvements
          - Improvement: Description (only if there are improvements, otherwise omit section)

          ## Breaking Changes
          None (or list them if any)

          ## Full Changelog
          https://github.com/kshivang/BossTerm/compare/${PREV_TAG}...${TAG}"

          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              '{
                model: "claude-sonnet-4-20250514",
                max_tokens: 2000,
                messages: [{role: "user", content: $prompt}]
              }')")

          # Extract content
          CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

          if [[ -z "$CONTENT" ]]; then
            echo "Error: Failed to generate release notes"
            echo "$RESPONSE"
            exit 1
          fi

          # Save to file
          mkdir -p docs/release-notes
          echo "$CONTENT" > "docs/release-notes/${TAG}.md"

          echo "Generated release notes for ${TAG}"

      - name: Update release notes index
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"
          RELEASE_DATE="${{ steps.release_info.outputs.release_date }}"

          # Create or update README
          INDEX_FILE="docs/release-notes/README.md"

          if [[ ! -f "$INDEX_FILE" ]]; then
            echo "# BossTerm Release Notes" > "$INDEX_FILE"
            echo "" >> "$INDEX_FILE"
            echo "## Releases" >> "$INDEX_FILE"
            echo "" >> "$INDEX_FILE"
          fi

          # Check if this version already exists
          if ! grep -q "\[${TAG}\]" "$INDEX_FILE"; then
            # Add new release after "## Releases" line
            sed -i "/^## Releases/a\\
          - [${TAG}](${TAG}.md) - ${RELEASE_DATE}" "$INDEX_FILE"
          fi

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TAG="${{ steps.release_info.outputs.tag }}"

          if [[ -n $(git status --porcelain docs/release-notes/) ]]; then
            git add docs/release-notes/
            git commit -m "docs: Add release notes for ${TAG}"
            git push
            echo "âœ… Release notes pushed for ${TAG}"
          else
            echo "No changes to push"
          fi
